{% extends 'base.html' %}

{% block title %}Stock Management - Django Ecommerce{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Stock Management</h1>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-6">
        <form method="get" class="d-flex">
            <input type="text" name="search" class="form-control" placeholder="Search products..." value="{{ request.GET.search }}">
            <button type="submit" class="btn btn-outline-secondary ms-2">Search</button>
        </form>
    </div>
    <div class="col-md-3">
        <form method="get">
            <div class="form-check">
                <input type="checkbox" name="low_stock" value="1" class="form-check-input" {% if low_stock_filter %}checked{% endif %} onchange="this.form.submit()">
                <label class="form-check-label">
                    Show only low stock items
                </label>
            </div>
        </form>
    </div>
</div>

<!-- Stock Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>SKU</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.name }}</td>
                        <td>{{ product.sku }}</td>
                        <td>{{ product.category.name }}</td>
                        <td class="stock-cell" data-product-id="{{ product.pk }}">
                            {% if product.stock < 10 %}
                            <span class="badge bg-danger">{{ product.stock }}</span>
                            {% elif product.stock < 20 %}
                            <span class="badge bg-warning">{{ product.stock }}</span>
                            {% else %}
                            <span class="badge bg-success">{{ product.stock }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if product.stock == 0 %}
                            <span class="text-danger">Out of Stock</span>
                            {% elif product.stock < 10 %}
                            <span class="text-warning">Low Stock</span>
                            {% else %}
                            <span class="text-success">In Stock</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary update-stock-btn" 
                                    data-product-id="{{ product.pk }}" 
                                    data-current-stock="{{ product.stock }}">
                                <i class="fas fa-edit"></i> Update Stock
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No products found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if products.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if products.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if low_stock_filter %}&low_stock=1{% endif %}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if low_stock_filter %}&low_stock=1{% endif %}">Previous</a>
                    </li>
                {% endif %}

                <li class="page-item active">
                    <span class="page-link">{{ products.number }} of {{ products.paginator.num_pages }}</span>
                </li>

                {% if products.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if low_stock_filter %}&low_stock=1{% endif %}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if low_stock_filter %}&low_stock=1{% endif %}">Last</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Update Stock Modal -->
<div class="modal fade" id="updateStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStockForm">
                    <div class="mb-3">
                        <label for="newStock" class="form-label">New Stock Quantity</label>
                        <input type="number" class="form-control" id="newStock" min="0" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStockBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentProductId = null;

    $('.update-stock-btn').click(function() {
        currentProductId = $(this).data('product-id');
        let currentStock = $(this).data('current-stock');
        $('#newStock').val(currentStock);
        $('#updateStockModal').modal('show');
    });

    $('#saveStockBtn').click(function() {
        let newStock = $('#newStock').val();
        if (currentProductId && newStock !== '') {
            $.post('{% url "dashboard:update_stock" 0 %}'.replace('0', currentProductId), {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'stock': newStock
            }, function(data) {
                if (data.success) {
                    // Update the stock display
                    let stockCell = $('.stock-cell[data-product-id="' + currentProductId + '"]');
                    let badgeClass = 'bg-success';
                    if (data.new_stock < 10) badgeClass = 'bg-danger';
                    else if (data.new_stock < 20) badgeClass = 'bg-warning';
                    
                    stockCell.html('<span class="badge ' + badgeClass + '">' + data.new_stock + '</span>');
                    
                    // Update button data
                    $('.update-stock-btn[data-product-id="' + currentProductId + '"]').data('current-stock', data.new_stock);
                    
                    $('#updateStockModal').modal('hide');
                    alert('Stock updated successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            });
        }
    });
});
</script>
{% endblock %}