{% extends 'base.html' %} 
{% load static %} 
{% block title %}
Products Create
{% endblock title %} 
{% block content %}

<div class="main-content">

            <div class="page-content">
                <div class="container-fluid">
                    <form action="{% url 'dashboard:product_edit' product.id %}" id="productDropzoneForm" method="post" class="row g-3" enctype="multipart/form-data">
                        {% csrf_token %}
                        <!-- start page title -->
                        <div class="row">

                            <div class="col-12">

                                    {% if messages %}
                                    {% for message in messages %}
                                        <div
                                        class="alert alert-{{ message.tags }} alert-dismissible fade show mb-xl-0 mb-2"
                                        role="alert"
                                        id="alert-{{ forloop.counter }}"
                                        >
                                        <strong>{{ message }}..!</strong>
                                        <button
                                            type="button"
                                            class="btn-close"
                                            data-bs-dismiss="alert"
                                            aria-label="Close"
                                        ></button>
                                        </div>
                                    {% endfor %}
                                    {% endif %}
                                    

                                </div>


                            <div class="col-12 mt-3">
                                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                    <h4 class="mb-sm-0">Edit Product</h4>

                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item">
                                            
                                                <button type="button" class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#AddCategoryModal">
                                                <i class="bi bi-plus-circle align-baseline me-1"></i>
                                                    Add Category
                                                </button>
                                                
                                               
                                            </li>
                                        </ol>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <!-- end page title -->

                        <div class="row">
                        
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            
                                            <div class="col-xxl-12">
                                                    <div class="row">
                                                        <div class="col-lg-12">
                                                            <div class="mb-3">
                                                                <label for="productTitle" class="form-label">Product Title <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" value="{{ product.name }}"  name="name" id="productTitle" placeholder="Enter product title" >
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="mb-3">
                                                                <label for="productCategories" class="form-label">Categories <span class="text-danger">*</span></label>
                                                                <select class="form-control" name="category" data-choices id="productCategories" required>
                                                                    <option value="{{ product.category.id }}">{{ product.category.name }}</option>
                                                                    {% for category in categories %}
                                                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="mb-3">
                                                                <label for="SubCategory" class="form-label">SubCategory <span class="text-danger">*</span></label>
                                                                <select class="form-control" name="subcategory" data-choices  id="SubCategory" required>
                                                                    <option value="{{ product.subcategory }}">{{ product.subcategory }}</option>
                                                                    <option value="Mens">Mens</option>
                                                                    <option value="Womens">Womens</option>
                                                                    <option value="Kids(Boys)">Kids(Boys)</option>
                                                                    <option value="Kids(Girls)">Kids(Girls)</option>
                            
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row">
                                                        <div class="mb-3">
                                                            <label for="shortDecs" class="form-label"> Description <span class="text-danger">*</span></label>
                                                            <textarea class="form-control" name="description"  id="shortDecs" placeholder="Must enter minimum of a 300 characters" rows="8">{{ product.description }}</textarea>
                                                        </div>
                                                    </div>
                                                     <div class="row mt-4">
                                                        <div class="col-lg-3">
                                                            <div class="mb-3">
                                                                <label for="weight" class="form-label">Weight (Gm)<span
                                                                        class="text-danger">*</span></label>
                                                                <input type="number" value="{{product.weight}}" name="weight" class="form-control" 
                                                                    id="weight" placeholder="Enter brand">
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <div class="mb-3">
                                                                <label for="dimensions_length" class="form-label">Length (Cm) <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="number" inputmode="decimal" value="{{product.dimensions_length}}" pattern="[0-9]*[.,]?[0-9]*" name="dimensions_length" class="form-control"
                                                                    placeholder="Enter Length">
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <div class="mb-3">
                                                                <label for="dimensions_width" class="form-label">Width (Cm) <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="number" inputmode="decimal" value="{{product.dimensions_width}}" pattern="[0-9]*[.,]?[0-9]*" name="dimensions_width" class="form-control"
                                                                    placeholder="Enter Width">
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <div class="mb-3">
                                                                <label for="dimensions_height" class="form-label">Height (Cm) <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="number" inputmode="decimal" value="{{product.dimensions_height}}" pattern="^\d*([.,]?\d+)?$" name="dimensions_height" class="form-control"
                                                                    placeholder="Enter Height">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-lg-4">
                                                            <div class="mb-3">
                                                                <label for="productBrand" class="form-label">Brand <span class="text-danger">*</span></label>
                                                                <input type="text" value="{{ product.brand }}"  name="brand" class="form-control" id="productBrand" placeholder="Enter brand" >
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4">
                                                            <div class="mb-3">
                                                                <label for="productBrand" class="form-label">Model name <span class="text-danger">*</span></label>
                                                                <input type="text" name="model_name" value="{{ product.model_name }}" class="form-control" id="productBrand" placeholder="Enter brand" >
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4">
                                                            <div class="mb-3">
                                                                <label for="hsn_code" class="form-label">HSN Code <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="text" name="hsn_code" value="{% if product.hsn_code %}{{product.hsn_code}}{% else %} 0 {%endif%}" class="form-control"
                                                                    placeholder="Enter HSN Code">
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4">
                                                            <div class="mb-3">
                                                                <label class="form-label" for="product-price-input">MRP Price <span class="text-danger">*</span></label>
                                                                <div class="input-group has-validation">
                                                                    <span class="input-group-text" id="product-price-addon">₹</span>
                                                                    <input type="number" value="{{ product.mrp }}" class="form-control" name="product_mrp_price" id="product-price-input" placeholder="Enter price" aria-label="Price" aria-describedby="product-price-addon" required>
                                                                    <div class="invalid-feedback">Please Enter a MRP price.</div>
                                                                </div>
                                                            </div>
                                                        </div><!--end col-->
                                                        <div class="col-lg-4">
                                                            <div class="mb-3">
                                                                <label class="form-label" for="product-price-input">Selling Price <span class="text-danger">*</span></label>
                                                                <div class="input-group has-validation">
                                                                    <span class="input-group-text" id="product-price-addon">₹</span>
                                                                    <input type="number" name="product_selling_price" value="{{ product.price }}" class="form-control" id="product-price-input" placeholder="Enter price" aria-label="Price" aria-describedby="product-price-addon" required>
                                                                    <div class="invalid-feedback">Please Enter a selling price.</div>
                                                                </div>
                                                            </div>
                                                        </div><!--end col-->
                                                        <div class="col-lg-4">
                                                            <div class="mb-3">
                                                                <label for="sku" class="form-label">Sku Code <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="text" name="sku" value="{{product.sku}}" class="form-control"
                                                                    placeholder="Enter SKU Code">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mt-3">
                                                        <div class="col-lg-2">
                                                            <div class="form-check form-switch mb-3">
                                                                <input type="checkbox" name="is_new_arrival" {% if product.is_new_arrival %}checked{% endif %} class="form-check-input" id="is_new_arrival">
                                                                <label class="form-check-label" for="is_new_arrival">New Arrival</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-2">
                                                            <div class="form-check form-switch mb-3">
                                                                <input type="checkbox" name="is_active" {% if product.is_active %}checked{% endif %} class="form-check-input" id="is_active">
                                                                <label class="form-check-label" for="is_active">Is Showing</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-2">
                                                            <div class="form-check form-switch mb-3">
                                                                <input type="checkbox" name="cod_available" {% if product.is_cod_available %}checked{% endif %} class="form-check-input" id="id_cod_available">
                                                                <label class="form-check-label" for="cod_available">Cod Available</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-2">
                                                            <div class="form-check form-switch mb-3">
                                                                <input type="checkbox" name="free_shipping" {% if product.free_shipping %}checked{% endif %} class="form-check-input" id="id_free_shipping">
                                                                <label class="form-check-label" for="free_shipping">Free Shipping</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-2">
                                                            <div class="form-check form-switch mb-3">
                                                                <input type="checkbox" name="returnable" {% if product.is_returnable %}checked{% endif %} class="form-check-input" id="refundableInput">
                                                                <label class="form-check-label" for="refundableInput">Returnable</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-2">
                                                            <div class="form-check form-switch mb-3">
                                                                <input class="form-check-input" type="checkbox" {% if product.is_replaceable %}checked{% endif %}  name="is_replaceable"
                                                                    id="is_replaceable">
                                                                <label class="form-check-label"
                                                                    for="is_replaceable">Replaceable</label>
                                                            </div>
                                                        </div>
                                                        
                                                    </div>


                                                     <div class="row mt-3">
                                                        <div class="col-lg-6" id="returnPeriodDiv" style="display: none;">
                                                            <div class="mb-3">
                                                                <label for="return_period" class="form-label">Return Period (Days) <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="text" name="return_period" value="{{product.return_period}}" class="form-control" 
                                                                    id="return_period" placeholder="Enter Return Period" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6"  id="replacePeriodDiv" style="display: none;">
                                                            <div class="mb-3">
                                                                <label for="replace_period" class="form-label">Replace Period (Days) <span
                                                                        class="text-danger">*</span></label>
                                                                <input type="text" name="replace_period" value="{{product.replace_period}}" class="form-control" 
                                                                    id="replace_period" placeholder="Enter Replace Period" required>
                                                            </div>
                                                        </div>
                                                        
                                                    </div>
                                                
                                            </div><!--end col-->
                                        </div><!--end row-->
                                    </div>
                                </div>
                            </div><!--end col-->
                        </div><!--end row-->

                    

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-body">
                                            <div class="row">
                                              <div class="col-xxl-12">
                                                <div class="mb-3">
                                                    <label class="form-label">Product Images <span class="text-danger">*</span></label>

                                                    <!-- Clickable Dropzone -->
                                                    <div class="dropzone text-center" id="dropzoneArea">
                                                        <!-- Hidden file input -->
                                                        <input id="fileInput" name="product_images" type="file" multiple style="display: none;">

                                                        <div class="dz-message needsclick">
                                                            <div class="mb-3">
                                                                <i class="display-4 text-muted ri-upload-cloud-2-fill"></i>
                                                            </div>
                                                            <h4>Drop product images here or click to upload.</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <ul class="list-unstyled mb-0" id="dropzone-preview">
                                                <li class="mt-2" id="dropzone-preview-list">
                                                    <!-- This is used as the file preview template -->
                                                    <div class="border rounded">
                                                        <div class="d-flex p-2">
                                                            <div class="flex-shrink-0 me-3">
                                                                <div class="avatar-sm bg-light rounded">
                                                                    <img data-dz-thumbnail class="img-fluid rounded d-block" src="assets/images/new-document.png" alt="Dropzone-Image" >
                                                                </div>
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <div class="pt-1">
                                                                    <h5 class="fs-md mb-1" data-dz-name>&nbsp;</h5>
                                                                    <p class="fs-sm text-muted mb-0" data-dz-size></p>
                                                                    <strong class="error text-danger" data-dz-errormessage></strong>
                                                                </div>
                                                            </div>
                                                            <div class="flex-shrink-0 ms-3">
                                                                <button data-dz-remove class="btn btn-sm btn-danger">Delete</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>


                                        <!-- Show existing product images -->
                                        <div class="row mt-3">
                                            {% for img in product.images.all %}
                                                <div class="col-sm-3 col-6 mb-3 image-card" id="image-{{ img.id }}">
                                                    <div class="position-relative border rounded p-1">
                                                        <!-- Delete Button -->
                                                        <button type="button" 
                                                                class="btn btn-sm btn-danger rounded position-absolute top-0 end-0 m-1 delete-image-btn" 
                                                                data-id="{{ img.id }}">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                        <!-- Image -->
                                                        <img src="{{ img.image.url }}" 
                                                            alt="{{ product.name }}" 
                                                            class="img-fluid rounded"
                                                            style="height:150px; width:100%; object-fit:contain;">
                                                    </div>
                                                </div>
                                            {% empty %}
                                                <div class="col-12">
                                                    <p>No images available for this product.</p>
                                                </div>
                                            {% endfor %}
                                        </div>

                                </div>
                            </div><!--end col-->
                        </div><!--end row-->
                           
                         <div class="row">
                        
                            <div class="col-lg-12">
                                <div class="">
                                    <div class="">
                                      
                                        <div class="hstack gap-2 justify-content-end mb-3">
                                            <button type="submit" class="btn btn-primary">Submit</button>
                                            <button type="reset" data-bs-dismiss="modal" class="btn btn-danger"><i class="ph-x align-middle"></i> Cancel</button>
                                            
                                        </div>


                                    </div>
                                </div>
                                
                            </div><!--end col-->

                            
                        </div><!--end row-->

                    </form>  
                        <div class="row">
                        
                            <div class="col-lg-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            
                                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                            <h4 class="mb-sm-0">Edit Variant</h4>

                                            <div class="page-title-right">
                                                <ol class="breadcrumb m-0">
                                                    <li class="breadcrumb-item">
                                                    
                                                        <button type="button" class="btn btn-primary " data-bs-toggle="modal" data-bs-target="#AddVariantModal">
                                                        <i class="bi bi-plus-circle align-baseline me-1"></i>
                                                            Add Variant
                                                        </button>
                                                        
                                                    
                                                    </li>
                                                </ol>
                                            </div>

                                        </div>

                                        {% for variant in product.variants.all %}
                                            <div class="col-xxl-3 col-lg-4 col-md-6">
                                                <div class="card ribbon-box ribbon-fill">
                                                    {% with discount_sizes=variant.sizes.all %}
                                                        {% if discount_sizes|length > 0 and discount_sizes.0.discount_percentage > 0  %}
                                                            <div class="ribbon ribbon-danger">Sale</div>
                                                        {% endif %}
                                                    {% endwith %}

                                                    <div class="card-body p-4 m-4">
                                                        <button type="button"
                                                            class="btn btn-sm btn-icon btn-subtle-danger position-absolute top-0 end-0 m-3 remove-list"
                                                            data-remove-id="{{ variant.id }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#deleteRecordModal-{{ variant.id }}">
                                                            <i class="ph-trash"></i>
                                                        </button>


                                                            <!-- deleteRecordModal -->
                                                                <div
                                                                    id="deleteRecordModal-{{ variant.id }}"
                                                                    class="modal fade zoomIn"
                                                                    tabindex="-1"
                                                                    aria-hidden="true"
                                                                >
                                                                    <div class="modal-dialog modal-dialog-centered">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header">
                                                                        <button
                                                                            type="button"
                                                                            class="btn-close"
                                                                            id="close-removemodal"
                                                                            data-bs-dismiss="modal"
                                                                            aria-label="Close"
                                                                        ></button>
                                                                        </div>
                                                                        <div class="modal-body p-md-5">
                                                                        <div class="text-center">
                                                                            <div class="text-danger">
                                                                            <i class="bi bi-trash display-5"></i>
                                                                            </div>
                                                                            <div class="mt-4">
                                                                            <h4 class="mb-2">Are you sure ?</h4>
                                                                            <p class="text-muted mx-3 mb-0">
                                                                                Are you sure you want to remove this variant ?
                                                                            </p>
                                                                            </div>
                                                                        </div>
                                                                        <div class="d-flex gap-2 justify-content-center mt-4 pt-2 mb-2">
                                                                            <button
                                                                            type="button"
                                                                            class="btn w-sm btn-light btn-hover"
                                                                            data-bs-dismiss="modal"
                                                                            >
                                                                            Close
                                                                            </button>
                                                                            <form method="POST" action="{% url 'dashboard:variant_delete' product.id  variant.id %}"   style="display:inline;">
                                                                                {% csrf_token %}
                                                                                <button type="submit" class="btn w-sm btn-danger" id="remove-product">Yes, Delete It!</button>
                                                                            </form>
                                                                        </div>
                                                                        </div>
                                                                    </div>
                                                                    <!-- /.modal-content -->
                                                                    </div>
                                                                    <!-- /.modal-dialog -->
                                                                </div>
                                                                <!-- /deleteRecordModal -->

                                                        {% with default_image=variant.images.first %}
                                                            {% if default_image  %}
                                                                <img src="{{ default_image.image.url }}"
                                                                    alt="{{ variant.color_name  }}"
                                                                    class="img-fluid"
                                                                    style="height: 82px;width: 120px;"/>
                                                            {% else %}
                                                                <img src="{% static 'dashboard/images/products/img-1.png' %}"
                                                                    alt="{{ product.name }}"
                                                                    class="img-fluid"
                                                                    style="height: 82px;width: 120px;"/>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>

                                                    <div class="card-body pt-0">
                                                      
                                                        {% for size in variant.sizes.all %}
                                                           <button type="button" class="btn btn-primary btn-sm size-block-{{ size.id }}"   data-bs-toggle="modal" data-edit-id="{{ size.id }}" data-bs-target="#EditSizeModal-{{ size.id }}">{{ size.size }}</button> 
                                                            <span class="size-block-{{ size.id }}"> -  ₹{{ size.get_price }} </span>
                                                            <span class="badge bg-danger mb-3 size-block-{{ size.id }}">{{ size.stock }} in stock</span>
                                                            <br>  

                                                        


                                                            <!-- EditVariantModal  --> 
                                                            <div class="modal fade bs-example-modal-center" tabindex="-1" role="dialog" id="EditSizeModal-{{ size.id }}" aria-labelledby="EditSizeModal-{{ size.id }}" aria-hidden="true">
                                                                <div class="modal-dialog modal-dialog-centered">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header text-center">
                                                                            
                                                                            <button type="button" class="btn btn-md btn-icon btn-subtle-danger m-3 delete-size-btn" data-product-id="{{ product.id }}" data-size-id="{{ size.id }}">
                                                                                <i class="ph-trash"></i>
                                                                            </button>
                                                                           



                                                                         </div>
                                                                        <div class="modal-body text-center p-5">
                                                                            <h5 class="mb-3">Edit Size -  {{size.size }}</h5>
                                                                            <form id="EditSizeForm-{{ size.id }}" action="{% url 'dashboard:size_variant_edit'  product.id size.id %}" method="post" class="row g-3" enctype="multipart/form-data">
                                                                            {% csrf_token %}
                                                                                <div class="row mt-3">
                                                                                   
                                                                                    <div class="col-lg-12">
                                                                                        <div class="mb-3">
                                                                                            <label for="productBrand" class="form-label">Mrp <span class="text-danger">*</span></label>
                                                                                            <input type="number" name="mrp" value="{{size.mrp}}" class="form-control"  >
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col-lg-12">
                                                                                        <div class="mb-3">
                                                                                            <label for="productBrand" class="form-label">Selling Price <span class="text-danger">*</span></label>
                                                                                            <input type="number" name="price" value="{{size.price}}" class="form-control"  >
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col-lg-12">
                                                                                        <div class="mb-3">
                                                                                            <label for="productBrand" class="form-label">Discount Price <span class="text-danger">*</span></label>
                                                                                            <input type="number" name="discount_price" value="{{size.discount_price}}"  class="form-control"  >
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col-lg-12">
                                                                                        <div class="mb-3">
                                                                                            <label for="productBrand" class="form-label">Stock  <span class="text-danger">*</span></label>
                                                                                            <input type="number" name="stock" value="{{size.stock}}"  class="form-control"  >
                                                                                        </div>
                                                                                    </div>
                                                                                    

                                                                                    
                                                                                </div><!--end row-->

                                                                                <div class="hstack gap-2 justify-content-end mb-3">
                                                                                    <button type="submit" class="btn btn-primary">Submit</button>
                                                                                    <button data-bs-dismiss="modal" type="reset" class="btn btn-danger"><i class="ph-x align-middle"></i> Cancel</button>
                                                                                    
                                                                                </div>
                                                                            </form>
                                                                            
                                                                        </div>
                                                                    </div><!-- /.modal-content -->
                                                                </div><!-- /.modal-dialog -->
                                                            </div><!-- /.modal -->


                                                       
                                                        {% endfor %}


                                                            
                                                        <br>
                                                        
                                                    <div data-bs-toggle="tooltip"  data-bs-placement="top"  >
                                                        <button type="button" style="background-color: {{ variant.hex_color_code }};" class="btn avatar-xs p-0 d-flex align-items-center justify-content-center border rounded-circle fs-5xl text-primary" disabled="">
                                                           
                                                        </button>
                                                    </div>

                                                        <div class="mt-3 hstack gap-2">
                                                            
                                                            <a type="button" data-bs-toggle="modal" data-edit-id="{{ variant.id }}" data-bs-target="#EditVariantModal-{{ variant.id }}" class="btn btn-secondary w-100">
                                                                <i class="ph-pencil me-1 align-middle"></i> Edit
                                                            </a>


                                                            <!-- EditVariantModal  --> 
                                                            <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" id="EditVariantModal-{{ variant.id }}" aria-labelledby="EditVariantModal-{{ variant.id }}" aria-hidden="true">
                                                                <div class="modal-dialog modal-lg">
                                                                    <div class="modal-content">
                                                                        <div class="modal-body text-center p-5">
                                                                            <h5 class="mb-3">Edit Variant -  {{variant.color_name }}</h5>
                                                                            <form id="EditVariantForm-{{ variant.id }}" action="{% url 'dashboard:variant_edit' product.id variant.id %}" method="post" class="row g-3" enctype="multipart/form-data">
                                                                            {% csrf_token %}
                                                                                <div class="row mt-3">
                                                                                                                                                
                                                                                    <div class="col-lg-6">
                                                                                        <label class="form-label" for="product-price-input">Colors <span class="text-danger">*</span></label>
                                                                                            
                                                                                        <div class="input-group">
                                                                                            <label class="input-group-text" for="inputGroupSelect01">Colors</label>
                                                                                            <select class="form-select" id="inputGroupSelect01" name="color_name">

                                                                                                <option value="{{variant.color_name}}">{{variant.color_name}}</option>
                                                                                                <option value="Black">Black</option>
                                                                                                <option value="Red">Red</option>
                                                                                                <option value="Green">Green</option>
                                                                                                <option value="Blue">Blue</option>
                                                                                                <option value="Yellow">Yellow</option>
                                                                                                <option value="Orange">Orange</option>
                                                                                                <option value="Purple">Purple</option>
                                                                                                <option value="Pink">Pink</option>
                                                                                                <option value="White">White</option>
                                                                                                <option value="Grey">Grey</option>
                                                                                                <option value="Brown">Brown</option>
                                                                                                <option value="Violet">Violet</option>
                                                                                                <option value="Indigo">Indigo</option>
                                                                                                <option value="Cyan">Cyan</option>
                                                                                                <option value="Magenta">Magenta</option>
                                                                                                <option value="Gold">Gold</option>
                                                                                                <option value="Silver">Silver</option>
                                                                                                <option value="Beige">Beige</option>
                                                                                                <option value="Maroon">Maroon</option>
                                                                                                <option value="Navy">Navy</option>
                                                                                                <option value="Teal">Teal</option>
                                                                                                <option value="Lime">Lime</option>
                                                                                                <option value="Olive">Olive</option>
                                                                                            </select>
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                
                                                                                    <div class="col-lg-6">
                                                                                        <div class="mb-3 ">
                                                                                            <label for="productBrand" class="form-label">Colour Code <span class="text-danger">*</span></label>
                                                                                            <div class="d-flex align-items-center">
                                                                                                <input type="color" 
                                                                                                    name="hex_color_code" 
                                                                                                    class="form-control form-control-color w-100 color-picker" 
                                                                                                    id="productColor-{{ variant.id }}" 
                                                                                                    value="{{ variant.hex_color_code }}" required>

                                                                                                <input type="text" 
                                                                                                    class="form-control color-display" 
                                                                                                    id="colorHexDisplay-{{ variant.id }}" 
                                                                                                    value="{{ variant.hex_color_code }}" readonly 
                                                                                                    style="max-width: 120px;">
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    
                                                                                    
                                                                                </div><!--end row-->

                                                                                <div class="row">
                                                                                    <!-- ===== SIZES (EDIT) ===== -->
                                                                                    <div class="col-lg-12 mt-3">
                                                                                    <label class="form-label">Size <span class="text-danger">*</span></label>

                                                                                    <!-- Master checkbox list (scoped by variant.id) -->

                                                                                    <div id="sizeOptions-edit-{{ variant.id }}" class="d-flex flex-wrap gap-2">
                                                                                    {% for s in size_list %}
                                                                                        {% comment %} check if this variant already has this size {% endcomment %}
                                                                                        {% with has_s=False sz_obj=None %}
                                                                                        {% for sz in variant.sizes.all %}
                                                                                            {% if sz.size|upper == s %}
                                                                                            {% with has_s=True sz_obj=sz %}{% endwith %}
                                                                                            {% endif %}
                                                                                        {% endfor %}
                                                                                        <label class="me-2 mb-2" id="sizeLabel-{{ variant.id }}-{{ s }}">
                                                                                            <input type="checkbox"
                                                                                                class="sizeOptionEdit"
                                                                                                value="{{ s }}"
                                                                                                {% if has_s %}
                                                                                                    checked disabled
                                                                                                    data-existing="1"
                                                                                                    data-size-id="{{ sz_obj.id }}"
                                                                                                {% else %}
                                                                                                    data-existing="0"
                                                                                                {% endif %}>
                                                                                            {{ s }}
                                                                                        </label>
                                                                                        {% endwith %}
                                                                                    {% endfor %}
                                                                                    </div>

                                                                                    <!-- Custom size add (type + Enter) -->
                                                                                    <div class="input-group mt-2">
                                                                                    <input type="text" id="customSizeInput-edit-{{ variant.id }}" class="form-control"
                                                                                            placeholder="Type custom size (e.g. 36) and press Enter">
                                                                                    </div>
                                                                                   

                                                                                    <!-- Table -->
                                                                                    <div class="col-lg-12 mt-3" id="sizeTableWrapper-edit-{{ variant.id }}" style="display:none;">
                                                                                    <table class="table table-bordered" id="sizeTable-edit-{{ variant.id }}">
                                                                                        <thead>
                                                                                        <tr>
                                                                                            <th>Size</th>
                                                                                            <th>MRP <span class="text-danger">*</span></th>
                                                                                            <th>Selling Price <span class="text-danger">*</span></th>
                                                                                            <th>Discount Price</th>
                                                                                            <th>Stock <span class="text-danger">*</span></th>
                                                                                            <th>Action</th>
                                                                                        </tr>
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            {% for sz in variant.sizes.all %}
                                                                                            <tr data-size="{{ sz.size|upper }}" data-existing="1" data-size-id="{{ sz.id }}">
                                                                                                <td>
                                                                                                {{ sz.size|upper }}
                                                                                                <input type="hidden" class="size" value="{{ sz.size|upper }}">
                                                                                                <input type="hidden" class="size_id" value="{{ sz.id }}">
                                                                                                </td>
                                                                                                <td><input type="number" class="form-control mrp" step="0.01" value="{{ sz.mrp }}" required></td>
                                                                                                <td><input type="number" class="form-control price" step="0.01" value="{{ sz.price }}" required></td>
                                                                                                <td><input type="number" class="form-control discount_price" step="0.01" value="{{ sz.discount_price|default:0 }}"></td>
                                                                                                <td><input type="number" class="form-control stock" step="1" value="{{ sz.stock }}" required></td>
                                                                                                <td>
                                                                                                <button type="button"
                                                                                                        class="btn btn-outline-danger btn-sm btn-delete-existing"
                                                                                                        data-size-id="{{ sz.id }}">Delete</button>
                                                                                                </td>
                                                                                            </tr>
                                                                                            {% endfor %}
                                                                                        </tbody>                    
                                                                                    </table>
                                                                                    </div>

                                                                                    <!-- JSON payload (scoped to this form) -->
                                                                                    <input type="hidden" name="sizes_json" id="sizesJson-edit-{{ variant.id }}">

                                                                                </div>

                                                                                <div class="row">
                                                                                    <div class="col-xxl-12">
                                                                                        <div class="mb-3">
                                           

                                                                                            <div class="col-lg-12 mt-3">
                                                                                                <label class="form-label">Variant Images <span class="text-danger">*</span></label>
                                                                                                <div class="dropzone text-center" id="EditvariantDropzone-{{ variant.id }}">
                                                                                                    <div class="dz-message needsclick">
                                                                                                        <div class="mb-3">
                                                                                                            <i class="display-4 text-muted ri-upload-cloud-2-fill"></i>
                                                                                                        </div>
                                                                                                        <h4>Drop product images here or click to upload.</h4>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <ul class="list-unstyled mb-0" id="variantdropzone-preview-{{ variant.id }}">
                                                                                        <li class="mt-2" id="variantdropzone-preview-list-{{ variant.id }}">
                                                                                            <!-- This is used as the file preview template -->
                                                                                            <div class="border rounded">
                                                                                                <div class="d-flex p-2">
                                                                                                    <div class="flex-shrink-0 me-3">
                                                                                                        <div class="avatar-sm bg-light rounded">
                                                                                                            <img data-dz-thumbnail class="img-fluid rounded d-block" src="assets/images/new-document.png" alt="Dropzone-Image" >
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="flex-grow-1">
                                                                                                        <div class="pt-1">
                                                                                                            <h5 class="fs-md mb-1" data-dz-name>&nbsp;</h5>
                                                                                                            <p class="fs-sm text-muted mb-0" data-dz-size></p>
                                                                                                            <strong class="error text-danger" data-dz-errormessage></strong>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="flex-shrink-0 ms-3">
                                                                                                        <button data-dz-remove class="btn btn-sm btn-danger">Delete</button>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </li>
                                                                                    </ul>

                                                                                    <!-- Show existing product images -->
                                                                                    <div class="row mt-3">
                                                                                        {% for img in variant.images.all %}
                                                                                            <div class="col-sm-4 col-6 mb-4 image-card variant-image-container variant-image-{{ img.id }}" id="image-{{ img.id }}">
                                                                                                <div class="position-relative border rounded p-1">
                                                                                                    <!-- Delete Button -->
                                                                                                    <button type="button" 
                                                                                                            class="btn btn-sm btn-danger rounded position-absolute top-0 end-0 m-1 delete-variantImage-btn" 
                                                                                                            data-id="{{ img.id }}">
                                                                                                        <i class="bi bi-x-lg"></i>
                                                                                                    </button>
                                                                                                    <!-- Image -->
                                                                                                    <img src="{{ img.image.url }}" 
                                                                                                        alt="{{ variant.color_name }}" 
                                                                                                        class="img-fluid rounded"
                                                                                                        style="height:150px; width:100%; object-fit:contain;">
                                                                                                </div>
                                                                                            </div>
                                                                                        {% empty %}
                                                                                            <div class="col-12">
                                                                                                <p>No images available for this product.</p>
                                                                                            </div>
                                                                                        {% endfor %}
                                                                                    </div>

                                                                                </div>



                                                                                <div class="row">
                                                                                    <div class="hstack gap-2 justify-content-end mb-3">
                                                                                        <button type="submit" class="btn btn-primary">Submit</button>
                                                                                        <button type="reset" class="btn btn-danger" data-bs-dismiss="modal"><i class="ph-x align-middle"></i> Cancel</button>
                                                                                        
                                                                                    </div>
                                                                                </div>
                                                                            </form>
                                                                            
                                                                        </div>
                                                                    </div><!-- /.modal-content -->
                                                                </div><!-- /.modal-dialog -->
                                                            </div><!-- /.modal -->

                                                            
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>

                                        {% endfor %}
                              

                                            
                                    </div><!--end row-->

                                       
                                    </div>
                                </div>
                                
                            </div><!--end col-->

                            
                        </div><!--end row-->


                        
                  
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->
        <!--start back-to-top-->
            <button class="btn btn-dark btn-icon" id="back-to-top">
            <i class="bi bi-caret-up fs-3xl"></i>
            </button>
    <!--end back-to-top-->
        
        </div>
        <!-- end main content-->

<!-- Modal --> 
<div class="modal fade bs-example-modal-center" tabindex="-1" role="dialog" id="AddCategoryModal" aria-labelledby="AddCategoryModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <h5 class="mb-3">Add New Category</h5>
                <form action="{% url 'dashboard:add_category' %}" method="post" class="row g-3" enctype="multipart/form-data">
                {% csrf_token %}
                    <div class="col-md-12">
                        <label for="fullnameInput" class="form-label">Name
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="fullnameInput" name="name" placeholder="Enter name" required>
                    </div>
                               
                    <div class="col-12">
                        <label for="inputAddress" class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" id="inputAddress" placeholder="Description">
                    </div>
                    <div class="col-12">
                        <label for="inputAddress" class="form-label">Image</label>
                        <input type="file" class="form-control" name="image" accept=".png,.jpeg,.jpg" id="inputAddress" >
                    </div>
                    
                    
                    <div class="col-12">
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">Create</button>
                        </div>
                    </div>
                </form>
                
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->




<!-- Modal --> 
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" id="AddVariantModal" aria-labelledby="AddVariantModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <h5 class="mb-3">Add New Variant</h5>
                <form id="variantForm" action="{% url 'dashboard:variant_create' product.id %}" method="post" class="row g-3" enctype="multipart/form-data">
                {% csrf_token %}
                     <div class="row mt-3">
                         
                        <div class="col-lg-6">
                            <label class="form-label" for="product-price-input">Colors <span class="text-danger">*</span></label>
                                
                            <div class="input-group">
                                <label class="input-group-text" for="inputGroupSelect01">Colors</label>
                                <select class="form-select" id="inputGroupSelect01" name="color_name">

                                    <option value="black">Black</option>
                                    <option value="red">Red</option>
                                    <option value="green">Green</option>
                                    <option value="blue">Blue</option>
                                    <option value="yellow">Yellow</option>
                                    <option value="orange">Orange</option>
                                    <option value="purple">Purple</option>
                                    <option value="pink">Pink</option>
                                    <option value="white">White</option>
                                    <option value="grey">Grey</option>
                                    <option value="brown">Brown</option>
                                    <option value="violet">Violet</option>
                                    <option value="indigo">Indigo</option>
                                    <option value="cyan">Cyan</option>
                                    <option value="magenta">Magenta</option>
                                    <option value="gold">Gold</option>
                                    <option value="silver">Silver</option>
                                    <option value="beige">Beige</option>
                                    <option value="maroon">Maroon</option>
                                    <option value="navy">Navy</option>
                                    <option value="teal">Teal</option>
                                    <option value="lime">Lime</option>
                                    <option value="olive">Olive</option>
                                </select>
                            </div>
                        </div>
                        
                       
                        <div class="col-lg-6">
                            <div class="mb-3 ">
                                <label for="productBrand" class="form-label">Colour Code <span class="text-danger">*</span></label>
                                <div class="d-flex align-items-center">
                                    <input type="color" 
                                        name="hex_color_code" 
                                        class="form-control form-control-color w-100 color-picker" 
                                        id="productColor-add" value="#000000" required>

                                    <input type="text" 
                                        class="form-control color-display" 
                                        id="colorHexDisplay-add" 
                                        readonly style="max-width: 120px;">
                                </div>
                            </div>
                        </div>
                      
                       <!-- Size Selection -->
                        <div class="col-lg-12 mt-3">
                            <label class="form-label">Size <span class="text-danger">*</span></label>
                            <div id="sizeOptions" class="d-flex flex-wrap gap-2">
                                <!-- Predefined sizes as checkboxes -->
                                <label><input type="checkbox" class="sizeOption" value="XXS"> XXS</label>
                                <label><input type="checkbox" class="sizeOption" value="XS"> XS</label>
                                <label><input type="checkbox" class="sizeOption" value="S"> S</label>
                                <label><input type="checkbox" class="sizeOption" value="M"> M</label>
                                <label><input type="checkbox" class="sizeOption" value="L"> L</label>
                                <label><input type="checkbox" class="sizeOption" value="XL"> XL</label>
                                <label><input type="checkbox" class="sizeOption" value="XXL"> XXL</label>
                                <label><input type="checkbox" class="sizeOption" value="XXXL"> XXXL</label>
                            </div>

                            <!-- Custom size input -->
                            <div class="input-group mt-2">
                                <input type="text" id="customSizeInput" class="form-control" placeholder="Type custom size (e.g. 36) and press Enter">
                            </div>
                            </div>


                      
                        <!-- Size Table -->
                        <div class="col-lg-12 mt-3" id="sizeTableWrapper" style="display:none;">
                        <table class="table table-bordered" id="sizeTable">
                            <thead>
                            <tr>
                                <th>Size</th>
                                <th>MRP *</th>
                                <th>Selling Price *</th>
                                <th>Discount Price</th>
                                <th>Stock *</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        </div>

                        <input type="hidden" name="sizes_json" id="sizesJson">


                        <!-- Variant Images -->
                        <div class="col-lg-12 mt-3">
                            <label class="form-label">Variant Images <span class="text-danger">*</span></label>
                           <div class="dropzone text-center" id="variantDropzone">
                                <div class="dz-message needsclick">
                                    <div class="mb-3">
                                        <i class="display-4 text-muted ri-upload-cloud-2-fill"></i>
                                    </div>
                                    <h4>Drop product images here or click to upload.</h4>
                                </div>
                            </div>
                        </div>
                                                
                                                
                        

                        
                    </div><!--end row-->

                    <div class="hstack gap-2 justify-content-end mb-3">
                        <button type="submit" class="btn btn-primary">Submit</button>
                        <button data-bs-dismiss="modal" type="reset" class="btn btn-danger"><i class="ph-x align-middle"></i> Cancel</button>
                        
                    </div>
                </form>
                
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



    <!-- init js -->
    <script src="{% static 'dashboard/js/pages/ecommerce-create-product.init.js' %}"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>

<script>
$(document).ready(function () {
    $(".color-picker").each(function () {
        let colorInput = $(this);
        let variantId = this.id.replace("productColor-", ""); // "add" or variant.id
        let colorHexDisplay = $(`#colorHexDisplay-${variantId}`);

        function updateColorCode() {
            let colorVal = colorInput.val();
            colorHexDisplay.val(colorVal);
            colorHexDisplay.css("background-color", colorVal);
            colorHexDisplay.css("color", "#fff");
        }

        updateColorCode(); // init
        colorInput.on("input", updateColorCode);
    });
});


</script>

<!-- Include jQuery if not already included -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    let selectedSizes = { add: [] };

    // Add button click (Add Variant)
    $(".add-size-btn").click(function () {
        let variantId = $(this).data("variant"); // "add" or number
        if (!selectedSizes[variantId]) {
            selectedSizes[variantId] = [];
        }

        let newSize = $(`#sizeInput-${variantId}`).val().trim();
        if (newSize !== "" && !selectedSizes[variantId].includes(newSize)) {
            selectedSizes[variantId].push(newSize);

            // update hidden field
            $(`#selectedSize-${variantId}`).val(selectedSizes[variantId].join(","));

            // show button
            $(`#selectedSizeContainer-${variantId}`).append(`
                <button type="button" class="btn rounded-pill btn-primary m-1">${newSize}</button>
            `);

            $(`#sizeInput-${variantId}`).val("");
        }
    });

    // ✅ Require at least 1 size before form submit
    // $("#AddVariantModal form").on("submit", function (e) {
    //     if (selectedSizes["add"].length === 0) {
    //         alert("Please add at least one size.");
    //         e.preventDefault(); // stop submit
    //     }
    // });
});

</script>



<script>
Dropzone.autoDiscover = false;

// Initialize Dropzone for product images only
const myDropzone = new Dropzone("#dropzoneArea", {
    url: "#", // we handle upload manually
    autoProcessQueue: false,
    uploadMultiple: true,
    paramName: "product_images",
    clickable: "#dropzoneArea",
    addRemoveLinks: true,
    acceptedFiles: "image/*",
    parallelUploads: 10
});

// Handle form submit
document.getElementById("productDropzoneForm").addEventListener("submit", function(e) {
    e.preventDefault(); // prevent normal submit

    const form = this;
    const formData = new FormData(form);

    // ✅ Append Dropzone images manually
    myDropzone.files.forEach(file => {
        formData.append("product_images", file, file.name);
    });

    console.log("🧾 Total product images sending:", myDropzone.files.length);

    // ✅ Send via fetch (to Django)
    fetch(form.action, {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url; // redirect after success
        } else {
            return response.text();
        }
    })
    .then(data => console.log("✅ Upload complete"))
    .catch(err => console.error("❌ Upload error:", err));
});

// ✅ Simple CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).on("click", ".delete-image-btn", function () {
    let imageId = $(this).data("id");
    let imageCard = $("#image-" + imageId);

    Swal.fire({
        title: "Are you sure?",
        text: "Do you really want to delete this image?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it!"
    }).then((result) => {
        if (result.isConfirmed) {
            const baseUrl = window.location.origin;  
            fetch(`${baseUrl}/product_image/delete/${imageId}/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"), // for Django
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                if (response.ok) {
                    Swal.fire("Deleted!", "Image deleted successfully.", "success");
                    imageCard.remove(); // remove from UI
                } else {
                    Swal.fire("Error!", "Failed to delete image.", "error");
                }
            })
            .catch(() => {
                Swal.fire("Error!", "Something went wrong.", "error");
            });
        }
    });
});

// ✅ Helper function to get CSRF token (for Django)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

</script>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>

<script>
/* ---------- SIZE CHECKBOX + CUSTOM ADD ---------- */
let selectedSizes = [];

function updateTable() {
  let tbody = document.querySelector("#sizeTable tbody");
  tbody.innerHTML = "";

  if (selectedSizes.length > 0) {
    document.getElementById("sizeTableWrapper").style.display = "block";
  } else {
    document.getElementById("sizeTableWrapper").style.display = "none";
  }

  selectedSizes.forEach(size => {
    let row = `
      <tr data-size="${size}">
        <td>${size}<input type="hidden" class="size" value="${size}"></td>
        <td><input type="number" class="form-control mrp" step="0.01" required></td>
        <td><input type="number" class="form-control price" step="0.01" required></td>
        <td><input type="number" class="form-control discount_price" step="0.01" required></td>
        <td><input type="number" class="form-control stock" step="1" required></td>
        <td><button type="button" class="btn btn-danger btn-sm removeRow" data-size="${size}">X</button></td>
      </tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  });

  // console print pannura place
  console.log("Selected Sizes:", selectedSizes);
}

// Handle predefined checkboxes
document.getElementById("sizeOptions").addEventListener("change", function(e) {
  if (e.target.classList.contains("sizeOption")) {
    let value = e.target.value.toUpperCase();
    if (e.target.checked) {
      if (!selectedSizes.includes(value)) selectedSizes.push(value);
    } else {
      selectedSizes = selectedSizes.filter(s => s !== value);
    }
    updateTable();
  }
});

// Handle custom size enter
document.getElementById("customSizeInput").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    let value = this.value.trim().toUpperCase();
    if (value && !selectedSizes.includes(value)) {
      selectedSizes.push(value);
      let label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" class="sizeOption" value="${value}" checked> ${value}`;
      document.getElementById("sizeOptions").appendChild(label);
      updateTable();
    }
    this.value = "";
  }
});

// Remove row manually
document.addEventListener("click", function(e) {
  if (e.target.classList.contains("removeRow")) {
    let size = e.target.getAttribute("data-size");
    selectedSizes = selectedSizes.filter(s => s !== size);
    let checkbox = document.querySelector(`#sizeOptions input[value="${size}"]`);
    if (checkbox) checkbox.checked = false;
    updateTable();
  }
});

// Before form submit
document.getElementById("variantForm").addEventListener("submit", function(e) {
  let data = [];
  document.querySelectorAll("#sizeTable tbody tr").forEach(row => {
    data.push({
      size: row.querySelector(".size").value,
      mrp: row.querySelector(".mrp").value,
      price: row.querySelector(".price").value,
      discount_price: row.querySelector(".discount_price").value || 0,
      stock: row.querySelector(".stock").value,
    });
  });

  if (data.length === 0) {
    e.preventDefault();
    alert("Please add at least one size."); 
    return false;
  }

  console.log("Final Table Data:", data,data.length); // 👉 console print

  document.getElementById("sizesJson").value = JSON.stringify(data);
});

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
<script>
Dropzone.autoDiscover = false;

let variantDropzone = new Dropzone("#variantDropzone", {
    url: "#",                      // ❌ we are not uploading via ajax
    autoProcessQueue: false,       // ❌ prevent auto upload
    clickable: "#variantDropzone", // ✅ now whole box clickable
    previewsContainer: "#variantDropzone",
    paramName: "variant_images",
    acceptedFiles: ".jpg,.jpeg,.png",
    uploadMultiple: true
});

// attach files to form before submit
document.getElementById("variantForm").addEventListener("submit", function() {
    let dzFiles = variantDropzone.getAcceptedFiles();
    dzFiles.forEach(file => {
        let dt = new DataTransfer();
        dt.items.add(file);
        let input = document.createElement("input");
        input.type = "file";
        input.name = "variant_images";   // multiple -> Django sees as list
        input.files = dt.files;
        input.style.display = "none";
        this.appendChild(input);
    });
});
</script>

<!-- edit varient dropzone image priview -->

<script>
Dropzone.autoDiscover = false;

document.querySelectorAll("form[id^='EditVariantForm-']").forEach(function(form) {
    let variantId = form.id.split("-")[1];  // form id → variant.id extract

    // Template setup
    let previewNode = document.querySelector("#variantdropzone-preview-list-" + variantId);
    previewNode.id = "";
    let previewTemplate = previewNode.outerHTML;
    previewNode.parentNode.removeChild(previewNode);

    // Dropzone init
    let dz = new Dropzone("#EditvariantDropzone-" + variantId, {
        url: form.action, // not used because we submit manually
        autoProcessQueue: false,   // don't auto-upload
        addRemoveLinks: true,
        maxFilesize: 5,
        acceptedFiles: "image/*",
        previewTemplate: previewTemplate,
        previewsContainer: "#variantdropzone-preview-" + variantId,
        clickable: "#EditvariantDropzone-" + variantId
    });

    // Attach Dropzone files into form before submit
    form.addEventListener("submit", function(e) {
        // Important → don’t preventDefault (because we want native submit)
        // But we need to inject Dropzone files
        let dzFiles = dz.getAcceptedFiles();

        dzFiles.forEach(file => {
            let dt = new DataTransfer();
            dt.items.add(file);

            let input = document.createElement("input");
            input.type = "file";
            input.name = "variant_images";   // Django -> request.FILES.getlist("variant_images")
            input.files = dt.files;
            input.style.display = "none";

            form.appendChild(input);
        });
    });
});

</script>
<!-- edit varient dropzone image priview -->

<!-- include SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.querySelectorAll('.delete-size-btn').forEach(button => {
  button.addEventListener('click', function () {
    const productId = this.dataset.productId;
    const sizeId = this.dataset.sizeId;
    const clickedButton = this;

    Swal.fire({
      html: `<i class="bi bi-trash display-5 bg-red"></i><br> Are you sure want to delete?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/product/${productId}/variant/size/${sizeId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({}),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Close parent modal
            const parentModal = clickedButton.closest('.modal');
            if (parentModal) {
              const modalInstance = bootstrap.Modal.getInstance(parentModal);
              if (modalInstance) {
                modalInstance.hide();
              }
            }

            // Remove entire size container div from DOM
            const sizeContainer = document.querySelectorAll(`.size-block-${sizeId}`).forEach(el => el.remove());
            if (sizeContainer) sizeContainer.remove();

            // Optionally remove modal from DOM
            const modal = document.getElementById(`EditSizeModal-${sizeId}`);
            if (modal) modal.remove();

            // Assuming the button is inside a container you want to remove,
            // adjust selector as per your markup

            // Example: If size buttons are inside a container div with data-size-id:
            const sizeButtonOnPage = document.querySelector(`[data-edit-id='${sizeId}']`);
            if (sizeButtonOnPage) {
              sizeButtonOnPage.remove();
            }

            // Show success swal (you can add trash icon here as well)
            Swal.fire({
              title: 'Deleted!',
              html: ` ${data.message}`,
              icon: 'success',
              timer: 5000,
              timerProgressBar: true,
              didOpen: (toast) => {
                toast.addEventListener('click', () => {
                  Swal.close();
                });
              }
            });
          } else {
            Swal.fire('Error', data.message || 'Could not delete.', 'error');
          }
        })
        .catch(() => {
          Swal.fire('Error', 'Network error occurred.', 'error');
        });
      }
    });
  });
});

// CSRF token helper function
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      const c = cookie.trim();
      if (c.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(c.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

<!-- variant image delete start-->
 <script>
  document.querySelectorAll('.delete-variantImage-btn').forEach(button => {
    button.addEventListener('click', function () {
      const imageId = this.dataset.id;
      const imageContainer = document.querySelector(`.variant-image-${imageId}`);

      Swal.fire({
        html: `<i class="bi bi-trash display-5 text-danger"></i><br>Are you sure you want to delete this image?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        focusCancel: true,
      }).then(result => {
        if (result.isConfirmed) {
          fetch(`/variant/image/${imageId}/delete/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Remove image container from DOM
              if (imageContainer) imageContainer.remove();

              // Show success Swal
              Swal.fire({
                title: 'Deleted!',
                html: ` ${data.message}`,
                icon: 'success',
                timer: 5000,
                timerProgressBar: true,
                didOpen: (toast) => {
                  toast.addEventListener('click', () => {
                    Swal.close();
                  });
                }
              });
            } else {
              Swal.fire('Error', data.message || 'Could not delete.', 'error');
            }
          })
          .catch(() => {
            Swal.fire('Error', 'Network error occurred.', 'error');
          });
        }
      });
    });
  });

  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const c = cookie.trim();
        if (c.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

<!-- variant image delete end -->


<!-- JavaScript to toggle visibility -->
<script>
const refundableInput = document.getElementById('refundableInput');
const returnPeriodDiv = document.getElementById('returnPeriodDiv');

const replaceableInput = document.getElementById('is_replaceable');
const replacePeriodDiv = document.getElementById('replacePeriodDiv');

function toggleReturnPeriod() {
    if (refundableInput.checked) {
        returnPeriodDiv.style.display = 'block';
        document.getElementById('return_period').required = true;
    } else {
        returnPeriodDiv.style.display = 'none';
        document.getElementById('return_period').required = false;
    }
}

function toggleReplacePeriod() {
    if (replaceableInput.checked) {
        replacePeriodDiv.style.display = 'block';
        document.getElementById('replace_period').required = true;
    } else {
        replacePeriodDiv.style.display = 'none';
        document.getElementById('replace_period').required = false;
    }
}

// Add event listeners
refundableInput.addEventListener('change', toggleReturnPeriod);
replaceableInput.addEventListener('change', toggleReplacePeriod);

// Initialize on page load
toggleReturnPeriod();
toggleReplacePeriod();

</script>



<!-- Edit Variant Size Management -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function(){
  function getCookie(name){
    let v = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(function(c){
        const t = c.trim();
        if (t.startsWith(name+'=')) v = decodeURIComponent(t.substring(name.length+1));
      });
    }
    return v;
  }

  // handle all edit variant forms
  document.querySelectorAll("form[id^='EditVariantForm-']").forEach(function(form){
    const variantId = form.id.split("-")[1];
    const sizeOptionsBox = document.getElementById(`sizeOptions-edit-${variantId}`);
    const customInput = document.getElementById(`customSizeInput-edit-${variantId}`);
    const tableWrapper = document.getElementById(`sizeTableWrapper-edit-${variantId}`);
    const table = document.getElementById(`sizeTable-edit-${variantId}`);
    const tbody = table ? table.querySelector("tbody") : null;
    const jsonInput = document.getElementById(`sizesJson-edit-${variantId}`);

    if (!tbody) return;
    function toggleWrapper(){ tableWrapper.style.display = tbody.children.length ? 'block' : 'none'; }
    toggleWrapper();

    function rowFor(sizeUpper){ return tbody.querySelector(`tr[data-size="${sizeUpper}"]`); }

    // Autofill source finder: prefer first existing row, else last row
    function autofillValues(){
      let source = tbody.querySelector('tr[data-existing="1"]');
      if (!source){
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (rows.length) source = rows[rows.length-1];
      }
      if (!source) return { mrp:'', price:'', discount_price:'', stock:'' };
      return {
        mrp: source.querySelector('.mrp')?.value || '',
        price: source.querySelector('.price')?.value || '',
        discount_price: source.querySelector('.discount_price')?.value || '',
        stock: source.querySelector('.stock')?.value || ''
      };
    }

    // add row (new size)
    function addRow(sizeUpper, isNew){
      if (rowFor(sizeUpper)) return;
      const vals = autofillValues();
      const tr = document.createElement('tr');
      tr.setAttribute('data-size', sizeUpper);
      tr.setAttribute('data-existing', isNew ? '0' : '1');

      tr.innerHTML = `
        <td>${sizeUpper}<input type="hidden" class="size" value="${sizeUpper}"></td>
        <td><input type="number" class="form-control mrp" step="0.01" value="${vals.mrp}" required></td>
        <td><input type="number" class="form-control price" step="0.01" value="${vals.price}" required></td>
        <td><input type="number" class="form-control discount_price" step="0.01" value="${vals.discount_price}"></td>
        <td><input type="number" class="form-control stock" step="1" value="${vals.stock}" required></td>
        <td><button type="button" class="btn btn-outline-danger btn-sm btn-cancel-row">Cancel</button></td>
      `;
      tbody.appendChild(tr);
      toggleWrapper();
    }

    // remove row (and uncheck & remove checkbox if non-existing)
    function removeRow(sizeUpper){
      const tr = rowFor(sizeUpper);
      if (tr) tr.remove();
      const cb = sizeOptionsBox.querySelector(`input.sizeOptionEdit[value="${sizeUpper}"]`);
      if (cb){
        // if cb was disabled (existing), remove the label entirely
        if (cb.disabled){
          const label = document.getElementById(`sizeLabel-${variantId}-${sizeUpper}`);
          if (label) label.remove();
        } else {
          cb.checked = false;
        }
      }
      toggleWrapper();
    }

    // when checkbox changed (only enabled checkboxes cause change)
    sizeOptionsBox.addEventListener('change', function(e){
      if (!e.target.classList.contains('sizeOptionEdit')) return;
      if (e.target.disabled) return;
      const sizeUpper = (e.target.value||'').toUpperCase();
      if (e.target.checked) {
        addRow(sizeUpper, true); // new
      } else {
        removeRow(sizeUpper);
      }
    });

    // custom input Enter
    customInput.addEventListener('keydown', function(e){
      if (e.key !== 'Enter') return;
      e.preventDefault();
      const val = (customInput.value||'').trim().toUpperCase();
      if (!val) return;

      // if size already exists in DB (disabled checkbox present) -> scroll to that row
      const existingCb = sizeOptionsBox.querySelector(`input.sizeOptionEdit[value="${val}"]`);
      if (existingCb && existingCb.disabled){
        // ensure its row visible
        const tr = rowFor(val);
        if (tr){
          tr.scrollIntoView({behavior:'smooth', block:'center'});
          tr.classList.add('flash-animate');
          setTimeout(()=>tr.classList.remove('flash-animate'), 1200);
        }
        customInput.value = '';
        return;
      }

      // create/ensure checkbox checked
      if (!existingCb){
        const label = document.createElement('label');
        label.className = 'me-2 mb-2';
        label.id = `sizeLabel-${variantId}-${val}`;
        label.innerHTML = `<input type="checkbox" class="sizeOptionEdit" value="${val}" checked> ${val}`;
        sizeOptionsBox.appendChild(label);
      } else {
        existingCb.checked = true;
      }
      // add new row autofilled
      addRow(val, true);
      customInput.value = '';
    });

    // table delegation: Cancel button (for new rows)
    tbody.addEventListener('click', function(e){
      if (e.target.classList.contains('btn-cancel-row')){
        const tr = e.target.closest('tr');
        const sizeUpper = tr.getAttribute('data-size');
        const isExisting = tr.getAttribute('data-existing') === '1';
        if (!isExisting){
          removeRow(sizeUpper);
        } else {
          // existing row cancel should not appear (we use delete flow)
          alert('Existing size - use Delete button.');
        }
      }
      // handle delete existing click
      if (e.target.classList.contains('btn-delete-existing')){
        const tr = e.target.closest('tr');
        const sizeId = e.target.getAttribute('data-size-id');
        const sizeUpper = tr.getAttribute('data-size');
        if (!sizeId) return;
        // confirm with Swal
        Swal.fire({
          title: `Delete size ${sizeUpper}?`,
          text: "This will remove the size from this variant.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Yes, delete",
        }).then((res)=>{
          if (!res.isConfirmed) return;
          // call delete endpoint (POST)
          fetch(`/product/{{ product.id }}/variant/${variantId}/size/${sizeId}/delete/`, {
            method: 'POST',
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie('csrftoken')
            },
            body: JSON.stringify({})
          }).then(r => r.json())
            .then(data => {
              if (data.success){
                // remove row and remove the checkbox label
                removeRow(sizeUpper);
                Swal.fire('Deleted','Size removed','success');
              } else {
                Swal.fire('Error', data.message || 'Could not delete','error');
              }
            }).catch(()=> Swal.fire('Error','Network error','error'));
        });
      }
    });

    // submit => build sizes_json
    form.addEventListener('submit', function(){
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const payload = rows.map(r => ({
        size: r.querySelector('.size')?.value || r.getAttribute('data-size'),
        size_id: r.querySelector('.size_id')?.value || null,
        mrp: r.querySelector('.mrp')?.value || '',
        price: r.querySelector('.price')?.value || '',
        discount_price: r.querySelector('.discount_price')?.value || '',
        stock: r.querySelector('.stock')?.value || '',
      }));
      if (jsonInput) jsonInput.value = JSON.stringify(payload);
    });

  }); // end form loop
})();
</script>

<style>
/* optional visual cue when we scroll to existing row */
.flash-animate{ animation: flash 1s ease; }
@keyframes flash { 0%{background: #fff;} 50%{background:#fff7cc;} 100%{background:#fff;} }
</style>


{% endblock content %}